context("Evaluate samples using SOM")
test_that("Creating clustering using Self-organizing Maps", {
    # skip_on_cran()
    data("cerrado_2classes")
    new_samples <- sits_cluster_som(
            cerrado_2classes,
            grid_xdim = 5,
            grid_ydim = 5
        )

    expect_true(all(new_samples$eval %in% c("clean", "analyze", "remove")))
    expect_true(new_samples[1, ]$post_prob > 0)
    grid_size <- 25
    expect_true(all(new_samples$id_neuron %in% c(1:grid_size)))

    set.seed(2903)
    som_map <- sits_som_map(
            samples_mt_4bands,
            grid_xdim = 10,
            grid_ydim = 10)

    expect_true(all(colnames(som_map$labelled_neurons) %in%
        c("id_neuron", "label_samples", "count", "prior_prob", "post_prob")))

    expect_true(som_map$labelled_neurons[1, ]$prior_prob >= 0)
    expect_true(som_map$labelled_neurons[1, ]$post_prob >= 0)
    expect_true(all(unique(som_map$labelled_neurons$id_neuron) %in% 1:100))

    cleaned_samples <- sits_som_clean_samples(som_map)
    expect_true("eval" %in% names(cleaned_samples))
    expect_true("post_prob" %in% names(cleaned_samples))

    expect_true(cleaned_samples[1, ]$post_prob > 0)

    cluster_purity <- suppressMessages(sits_som_evaluate_cluster(som_map))

    expect_true("cluster" %in% names(cluster_purity))
    expect_true("class" %in% names(cluster_purity))
    expect_true("mixture_percentage" %in% names(cluster_purity))

})
